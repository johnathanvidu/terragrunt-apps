spec_version: 2

workflow:
  scope: env
  triggers:
    - type: manual


inputs:
 
grains:
  render-env:
    kind: shell
    spec:
      agent: 
        name: 'vido-vido-prod'
      workspace-directories:
        - source:
            store: 'terragrunt-apps'
            name: 'ENVIRONMENTS_PATH'
      files:
        - source: 'terragrunt-apps'
          path: 'scripts/render-env.sh'
      activities:
        deploy:
          commands:
            - 'echo "installing dependencies"'
            - 'export YQ_VERSION="v4.35.2"'
            - 'apt install -y apt-transport-https || { echo "Failed to install dependencies"; exit 1; }'
            - 'wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg || { echo "Failed to add gh key"; exit 1; }'
            - 'echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null'
            - 'apt update'
            - 'apt install -y apt-transport-https gh || { echo "Failed to install gh"; exit 1; }'
            - 'wget "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64" -O /usr/local/bin/yq || { echo "Failed to download yq"; exit 1; }'
            - 'chmod +x /usr/local/bin/yq'
            - 'echo "depdendencies installed"'
            - 'git config --global user.email "johnathan.v@quali.com"'
            - 'git config --global user.name "johnathanvidu"'
            - '(cd $ENVIRONMENTS_PATH/scripts ; chmod +x ./render-env.sh ; ./render-env.sh {{ spaceName }} {{ .bindings.environment_id }} {{ .bindings.inputs.app_name }}-dev --output blueprints/{{ .bindings.inputs.app_name }}.yaml )'